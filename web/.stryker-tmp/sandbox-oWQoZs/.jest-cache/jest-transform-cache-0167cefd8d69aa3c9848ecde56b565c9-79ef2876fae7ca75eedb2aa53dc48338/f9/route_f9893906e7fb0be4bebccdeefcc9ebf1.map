{"version":3,"names":["GET","cov_w8qxapg25","f","s","POST","resend","_resend","Resend","process","env","RESEND_API_KEY","newsletterSchema","_zod","z","object","email","string","min","max","transform","toLowerCase","trim","source","optional","default","request","console","log","b","error","_server","NextResponse","json","success","code","status","body","validationResult","safeParse","errors","details","data","userAgent","headers","get","emailData","emailError","emails","send","from","to","subject","react","_WelcomeEmail","html","adminEmailError","Date","toISOString","warn","adminError","message","timestamp","name","NODE_ENV","undefined","endpoint","method","description","version","provider","features"],"sources":["/home/jack/Documents/aclue-preprod/web/src/app/api/newsletter/signup/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { Resend } from 'resend'\nimport { z } from 'zod'\nimport WelcomeEmail from '@/components/emails/WelcomeEmail'\n\n/**\n * Newsletter Signup API Route - Direct Resend Integration\n * \n * This API route handles newsletter signups using Resend directly from Next.js,\n * bypassing the FastAPI backend for improved reliability and performance.\n * \n * Features:\n * - Direct Resend SDK integration\n * - React email templates with aclue branding\n * - Input validation with Zod\n * - Comprehensive error handling\n * - Source tracking for analytics\n * - British English content and responses\n * \n * Based on official Resend documentation patterns:\n * https://resend.com/docs/send-with-nextjs\n */\n\n// Initialize Resend client\nconst resend = new Resend(process.env.RESEND_API_KEY)\n\n// Input validation schema\nconst newsletterSchema = z.object({\n  email: z\n    .string()\n    .min(1, 'Email is required')\n    .email('Please enter a valid email address')\n    .max(320, 'Email address is too long')\n    .transform(email => email.toLowerCase().trim()),\n  source: z.string().optional().default('maintenance_page_direct'),\n})\n\n/**\n * POST /api/newsletter/signup\n * \n * Handles newsletter signup requests with direct Resend integration.\n * Sends welcome email using React email template.\n */\nexport async function POST(request: NextRequest) {\n  try {\n    console.log('üìß Newsletter signup API route called')\n\n    // Check if Resend API key is configured\n    if (!process.env.RESEND_API_KEY) {\n      console.error('‚ùå RESEND_API_KEY not configured')\n      return NextResponse.json(\n        { \n          success: false, \n          error: 'Email service not configured. Please try again later.',\n          code: 'CONFIGURATION_ERROR'\n        },\n        { status: 500 }\n      )\n    }\n\n    // Parse and validate request body\n    const body = await request.json()\n    console.log('üìã Newsletter signup data:', { email: body.email, source: body.source })\n\n    const validationResult = newsletterSchema.safeParse(body)\n\n    if (!validationResult.success) {\n      console.error('‚ùå Newsletter validation failed:', validationResult.error.errors)\n      return NextResponse.json(\n        {\n          success: false,\n          error: 'Invalid email address format',\n          code: 'VALIDATION_ERROR',\n          details: validationResult.error.errors,\n        },\n        { status: 400 }\n      )\n    }\n\n    const { email, source } = validationResult.data\n\n    // Get user agent for tracking\n    const userAgent = request.headers.get('user-agent') || 'Unknown'\n    \n    console.log('üåê Sending welcome email via Resend to:', email)\n\n    // Send welcome email using Resend\n    const { data: emailData, error: emailError } = await resend.emails.send({\n      from: 'aclue <noreply@aclue.app>',\n      to: [email],\n      subject: 'Welcome to aclue - AI-Powered Gift Discovery! üéÅ',\n      react: WelcomeEmail({ email, source }),\n      // Also provide HTML fallback for email clients that don't support React\n      html: `\n        <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">\n          <div style=\"background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: white; padding: 30px; text-align: center;\">\n            <h2>Welcome to aclue! üöÄ</h2>\n            <p>AI-Powered Gift Discovery</p>\n          </div>\n          <div style=\"padding: 30px; background: #f8fafc;\">\n            <h3>Thank you for joining our community!</h3>\n            <p>You're among the first to experience how AI can revolutionise gift-giving.</p>\n            <p>We'll keep you updated on our progress and notify you when our AI is ready to transform your gift-giving experience.</p>\n            <p>Excited to have you on board,<br>The aclue Team</p>\n          </div>\n        </div>\n      `,\n    })\n\n    if (emailError) {\n      console.error('‚ùå Resend email sending failed:', emailError)\n      return NextResponse.json(\n        {\n          success: false,\n          error: 'Failed to send welcome email. Please try again.',\n          code: 'EMAIL_SEND_ERROR',\n          details: emailError,\n        },\n        { status: 500 }\n      )\n    }\n\n    console.log('‚úÖ Welcome email sent successfully:', emailData)\n\n    // Optional: Store subscriber in database\n    // This could be added later if local storage is needed\n    // await storeNewsletterSubscriber(email, source, userAgent)\n\n    // Send admin notification (optional)\n    try {\n      const { error: adminEmailError } = await resend.emails.send({\n        from: 'aclue <noreply@aclue.app>',\n        to: ['contact@aclue.app'],\n        subject: `New Newsletter Signup: ${email}`,\n        html: `\n          <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">\n            <div style=\"background: #1f2937; color: white; padding: 20px; text-align: center;\">\n              <h2>üéâ New Newsletter Signup - aclue</h2>\n            </div>\n            <div style=\"padding: 20px; background: #f9fafb;\">\n              <p>A new user has signed up for the aclue newsletter!</p>\n              <div style=\"background: white; padding: 15px; border-left: 4px solid #3b82f6; margin: 15px 0;\">\n                <p><strong>Email:</strong> ${email}</p>\n                <p><strong>Source:</strong> ${source}</p>\n                <p><strong>Timestamp:</strong> ${new Date().toISOString()}</p>\n                <p><strong>User Agent:</strong> ${userAgent}</p>\n              </div>\n              <p>The subscriber has been automatically sent a welcome email.</p>\n            </div>\n          </div>\n        `,\n      })\n\n      if (adminEmailError) {\n        console.warn('‚ö†Ô∏è Admin notification failed:', adminEmailError)\n        // Don't fail the main request if admin notification fails\n      } else {\n        console.log('‚úÖ Admin notification sent successfully')\n      }\n    } catch (adminError) {\n      console.warn('‚ö†Ô∏è Admin notification error:', adminError)\n      // Don't fail the main request if admin notification fails\n    }\n\n    // Return success response\n    return NextResponse.json(\n      {\n        success: true,\n        message: \"Thank you! You're now on our mailing list and will be among the first to experience our AI-powered gift discovery platform.\",\n        code: 'SIGNUP_SUCCESS',\n        data: {\n          email,\n          source,\n          timestamp: new Date().toISOString(),\n        },\n      },\n      { status: 200 }\n    )\n\n  } catch (error: any) {\n    console.error('üí• Newsletter signup error:', error)\n\n    // Enhanced error classification\n    if (error.name === 'SyntaxError') {\n      return NextResponse.json(\n        {\n          success: false,\n          error: 'Invalid request format',\n          code: 'INVALID_JSON',\n        },\n        { status: 400 }\n      )\n    }\n\n    return NextResponse.json(\n      {\n        success: false,\n        error: 'An unexpected error occurred. Please try again.',\n        code: 'UNKNOWN_ERROR',\n        details: process.env.NODE_ENV === 'development' ? error.message : undefined,\n      },\n      { status: 500 }\n    )\n  }\n}\n\n/**\n * GET /api/newsletter/signup\n * \n * Returns information about the newsletter signup endpoint.\n * Useful for health checks and documentation.\n */\nexport async function GET() {\n  return NextResponse.json(\n    {\n      endpoint: '/api/newsletter/signup',\n      method: 'POST',\n      description: 'Newsletter signup with direct Resend integration',\n      version: '1.0.0',\n      status: 'operational',\n      provider: 'Resend',\n      features: [\n        'Direct Resend SDK integration',\n        'React email templates',\n        'Input validation with Zod',\n        'Admin notifications',\n        'Source tracking',\n      ],\n    },\n    { status: 200 }\n  )\n}"],"mappings":"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","ignoreList":[]}