# =============================================================================
# aclue Platform Security Thresholds Master Configuration
# =============================================================================
#
# Master threshold configuration defining precise security limits and failure
# conditions for the aclue platform's automated security scanning pipeline.
#
# Version: 1.0.0
# Last Updated: September 2025
# Security Maturity Level: High (89/100)
#
# =============================================================================

metadata:
  version: "1.0.0"
  platform: "aclue"
  description: "AI-powered gifting platform security thresholds"
  security_contact: "security@aclue.app"
  created: "2025-09-24"
  review_cycle: "monthly"
  compliance_standards:
    - "OWASP Top 10"
    - "CWE Top 25"
    - "PCI DSS"
    - "ISO 27001"
    - "GDPR"

# =============================================================================
# VULNERABILITY SEVERITY THRESHOLDS
# =============================================================================

vulnerability_thresholds:
  # CVSS v3.1 Score-based thresholds
  cvss_scores:
    critical:
      range: "9.0-10.0"
      production: 0            # Zero tolerance in production
      staging: 0               # Zero tolerance in staging
      development: 0           # Zero tolerance in development
      feature_branches: 1      # Allow 1 for rapid iteration with review

    high:
      range: "7.0-8.9"
      production: 0            # Zero tolerance in production
      staging: 1               # Allow 1 with mandatory review
      development: 3           # Allow 3 for development velocity
      feature_branches: 5      # Allow 5 with tracking

    medium:
      range: "4.0-6.9"
      production: 2            # Allow 2 with justification
      staging: 5               # Allow 5 with monitoring
      development: 10          # Allow 10 with documentation
      feature_branches: 20     # Allow 20 with awareness

    low:
      range: "0.1-3.9"
      production: 10           # Allow 10 with tracking
      staging: 20              # Allow 20 with periodic review
      development: 50          # Allow 50 with quarterly review
      feature_branches: 100    # Allow 100 with reporting

  # Age-based vulnerability degradation (days)
  age_escalation:
    critical:
      immediate: 0             # Must fix immediately
      escalate_to_blocker: 0   # Blocks deployment instantly

    high:
      grace_period: 7          # 7 days to remediate
      escalate_to_critical: 14 # Becomes critical after 14 days

    medium:
      grace_period: 30         # 30 days to remediate
      escalate_to_high: 60     # Becomes high after 60 days

    low:
      grace_period: 90         # 90 days to remediate
      escalate_to_medium: 180  # Becomes medium after 180 days

  # Exploitability factors
  exploitability:
    actively_exploited:
      multiplier: 2.0          # Double the severity score
      auto_block: true         # Always block deployment

    proof_of_concept:
      multiplier: 1.5          # 1.5x severity score
      require_review: true     # Mandatory security review

    theoretical:
      multiplier: 1.0          # Standard severity score
      allow_exception: true    # Can be excepted with approval

# =============================================================================
# SECRET DETECTION THRESHOLDS
# =============================================================================

secret_detection:
  # Confidence levels and actions
  confidence_levels:
    confirmed:
      threshold: 0             # Zero tolerance
      action: "block"          # Block immediately
      notification: "immediate" # Alert security team
      requires: "rotation"     # Force secret rotation

    high_confidence:
      threshold: 0             # Zero tolerance
      action: "block"          # Block deployment
      review: "manual"         # Require manual review
      sla: "1_hour"           # Review within 1 hour

    medium_confidence:
      threshold: 1             # Allow 1 maximum
      action: "warn"           # Warning with review
      review: "automated"      # Automated validation
      sla: "4_hours"          # Review within 4 hours

    low_confidence:
      threshold: 5             # Allow 5 maximum
      action: "log"            # Log for audit
      review: "batch"          # Batch review weekly
      documentation: true      # Require documentation

  # Secret type priorities
  secret_types:
    api_keys:
      - pattern: "production_api"
        severity: "critical"
        auto_rotate: true
      - pattern: "staging_api"
        severity: "high"
        auto_rotate: false
      - pattern: "development_api"
        severity: "medium"
        auto_rotate: false

    database_credentials:
      - pattern: "production_db"
        severity: "critical"
        auto_rotate: true
      - pattern: "staging_db"
        severity: "critical"
        auto_rotate: true
      - pattern: "development_db"
        severity: "high"
        auto_rotate: false

    service_tokens:
      - pattern: "jwt_secret"
        severity: "critical"
        auto_rotate: true
      - pattern: "oauth_secret"
        severity: "critical"
        auto_rotate: true
      - pattern: "webhook_secret"
        severity: "high"
        auto_rotate: false

# =============================================================================
# CODE QUALITY SECURITY THRESHOLDS
# =============================================================================

code_quality_security:
  # ESLint Security Rules
  eslint_security:
    error_threshold: 0         # No security errors allowed
    warning_threshold: 5       # Up to 5 warnings allowed
    rules:
      no_eval: "error"
      no_implied_eval: "error"
      no_new_func: "error"
      no_script_url: "error"
      no_unsafe_negation: "error"
      require_safe_regex: "error"
      detect_buffer_noassert: "error"
      detect_child_process: "error"
      detect_disable_mustache_escape: "error"
      detect_eval_with_expression: "error"
      detect_no_csrf_before_method_override: "error"
      detect_non_literal_fs_filename: "error"
      detect_non_literal_regexp: "error"
      detect_non_literal_require: "error"
      detect_object_injection: "error"
      detect_possible_timing_attacks: "warning"
      detect_pseudoRandomBytes: "error"
      detect_sql_injection: "error"
      detect_unsafe_regex: "error"

  # Bandit (Python) Security
  bandit_security:
    confidence_levels:
      high:
        production: 0          # No high confidence issues
        staging: 0             # No high confidence issues
        development: 1         # Allow 1 for debugging

      medium:
        production: 0          # No medium confidence issues
        staging: 2             # Allow 2 with review
        development: 5         # Allow 5 with documentation

      low:
        production: 5          # Allow 5 with justification
        staging: 10            # Allow 10 with tracking
        development: 20        # Allow 20 with awareness

  # Semgrep Pattern Detection
  semgrep_rules:
    cwe_patterns:
      critical_cwes:          # Block on detection
        - "CWE-89"            # SQL Injection
        - "CWE-78"            # OS Command Injection
        - "CWE-79"            # Cross-site Scripting
        - "CWE-434"           # Unrestricted File Upload
        - "CWE-611"           # XXE
        - "CWE-918"           # SSRF
        threshold: 0

      high_cwes:              # Warn and review
        - "CWE-200"           # Information Exposure
        - "CWE-352"           # CSRF
        - "CWE-285"           # Improper Authorization
        - "CWE-287"           # Improper Authentication
        threshold: 2

      medium_cwes:            # Track and monitor
        - "CWE-20"            # Improper Input Validation
        - "CWE-125"           # Out-of-bounds Read
        - "CWE-416"           # Use After Free
        threshold: 5

# =============================================================================
# DEPENDENCY VULNERABILITY THRESHOLDS
# =============================================================================

dependency_vulnerabilities:
  # Direct dependencies (stricter)
  direct_dependencies:
    critical:
      production: 0            # Zero tolerance
      staging: 0               # Zero tolerance
      development: 0           # Zero tolerance
      auto_update: true        # Auto-update if patch available

    high:
      production: 0            # Zero tolerance
      staging: 1               # Allow 1 with review
      development: 2           # Allow 2 with plan
      update_sla: "24_hours"   # Must update within 24 hours

    medium:
      production: 2            # Allow 2 with monitoring
      staging: 5               # Allow 5 with tracking
      development: 10          # Allow 10 with documentation
      update_sla: "7_days"     # Must update within 7 days

    low:
      production: 10           # Allow 10 with awareness
      staging: 20              # Allow 20 with reporting
      development: 50          # Allow 50 with quarterly review
      update_sla: "30_days"    # Must update within 30 days

  # Transitive dependencies (relaxed)
  transitive_dependencies:
    critical:
      production: 1            # Allow 1 with exception
      staging: 2               # Allow 2 with review
      development: 3           # Allow 3 with tracking
      requires_exception: true # Must document exception

    high:
      production: 3            # Allow 3 with monitoring
      staging: 5               # Allow 5 with awareness
      development: 10          # Allow 10 with documentation
      monitor_upstream: true   # Monitor for upstream fixes

    medium:
      production: 10           # Allow 10 with tracking
      staging: 20              # Allow 20 with reporting
      development: 50          # Allow 50 with batch review
      review_cycle: "monthly"  # Monthly review cycle

    low:
      production: 50           # Allow 50 with awareness
      staging: 100             # Allow 100 with quarterly review
      development: 200         # Allow 200 with annual review
      review_cycle: "quarterly" # Quarterly review cycle

  # Package-specific overrides
  package_overrides:
    - package: "webpack"
      vulnerabilities:
        - id: "GHSA-xxxx"
          allowed_until: "2025-12-31"
          reason: "No exploit path in our usage"

    - package: "node-sass"
      vulnerabilities:
        - id: "CVE-2024-xxxx"
          allowed_environments: ["development"]
          reason: "Build-time only dependency"

# =============================================================================
# CONTAINER SECURITY THRESHOLDS
# =============================================================================

container_security:
  # Base image requirements
  base_image:
    allowed_registries:
      - "docker.io"
      - "gcr.io"
      - "public.ecr.aws"
    prohibited_tags:
      - "latest"              # No latest tags in production
      - "dev"                 # No dev tags in production
    max_age_days: 30          # Base image must be < 30 days old
    require_signature: true   # Must be signed

  # Image vulnerability thresholds
  image_vulnerabilities:
    os_packages:
      critical: 0             # No critical OS vulnerabilities
      high: 2                 # Allow 2 high with justification
      medium: 10              # Allow 10 medium with tracking
      low: 50                 # Allow 50 low with awareness

    application_packages:
      critical: 0             # No critical app vulnerabilities
      high: 1                 # Allow 1 high with review
      medium: 5               # Allow 5 medium with documentation
      low: 20                 # Allow 20 low with tracking

  # Dockerfile security
  dockerfile_checks:
    prohibited_instructions:
      - "ADD"                 # Use COPY instead
      - "sudo"                # No sudo in containers
      - "chmod 777"           # No world-writable files
    required_instructions:
      - "USER"                # Must run as non-root
      - "HEALTHCHECK"         # Must have health check
    max_layers: 50            # Maximum 50 layers
    max_size_mb: 500          # Maximum 500MB image size

# =============================================================================
# INFRASTRUCTURE AS CODE (IaC) SECURITY
# =============================================================================

iac_security:
  # Terraform/OpenTofu thresholds
  terraform:
    critical_violations: 0     # No critical violations
    high_violations: 2         # Allow 2 high with review
    medium_violations: 10      # Allow 10 medium with documentation
    low_violations: 50         # Allow 50 low with tracking

  # Kubernetes manifests
  kubernetes:
    security_policies:
      - "pod_security_standards"
      - "network_policies"
      - "rbac_policies"
    prohibited_capabilities:
      - "SYS_ADMIN"
      - "NET_ADMIN"
      - "SYS_PTRACE"
    required_security_context:
      - "runAsNonRoot: true"
      - "readOnlyRootFilesystem: true"
      - "allowPrivilegeEscalation: false"

  # Cloud provider specific
  cloud_security:
    aws:
      prohibited_actions:
        - "*:*"               # No wildcard permissions
        - "iam:PassRole"      # Restricted PassRole
      required_encryption:
        - "s3"                # S3 encryption required
        - "rds"               # RDS encryption required
        - "ebs"               # EBS encryption required

    vercel:
      environment_variables:
        require_encryption: true
        require_rotation: "90_days"

    railway:
      deployment_security:
        require_private_networking: true
        require_ssl: true

# =============================================================================
# LICENSE COMPLIANCE THRESHOLDS
# =============================================================================

license_compliance:
  # Approved licenses
  approved_licenses:
    permissive:               # Always allowed
      - "MIT"
      - "Apache-2.0"
      - "BSD-2-Clause"
      - "BSD-3-Clause"
      - "ISC"
      - "0BSD"
      - "Unlicense"
      - "CC0-1.0"

    weak_copyleft:            # Allowed with review
      - "MPL-2.0"
      - "LGPL-2.1"
      - "LGPL-3.0"
      review_required: true

    notice:                   # Allowed with attribution
      - "Apache-1.1"
      - "PHP-3.0"
      attribution_required: true

  # Prohibited licenses
  prohibited_licenses:
    strong_copyleft:          # Never allowed
      - "GPL-2.0"
      - "GPL-3.0"
      - "AGPL-1.0"
      - "AGPL-3.0"
      - "OSL-3.0"
      - "EUPL-1.2"
      action: "block"

    commercial:               # Requires license
      - "Commercial"
      - "Proprietary"
      action: "review"

    unknown:                  # Unknown licenses
      production: "block"      # Block in production
      staging: "warn"          # Warn in staging
      development: "log"       # Log in development

  # Dependency license validation
  validation:
    direct_dependencies:
      enforce: true            # Strictly enforce
      allow_unknown: false     # No unknown licenses

    transitive_dependencies:
      enforce: true            # Enforce with exceptions
      allow_unknown: true      # Allow with documentation
      max_unknown: 5           # Maximum 5 unknown

# =============================================================================
# AUTHENTICATION & AUTHORIZATION THRESHOLDS
# =============================================================================

auth_security:
  # JWT Configuration
  jwt:
    min_key_length: 256        # Minimum 256 bits
    required_algorithms:
      - "RS256"                # RSA with SHA-256
      - "ES256"                # ECDSA with SHA-256
    prohibited_algorithms:
      - "none"                 # No unsigned tokens
      - "HS256"                # No symmetric in production
    max_expiry_seconds: 3600  # 1 hour maximum
    require_refresh: true      # Must have refresh token

  # Password Policy
  password_policy:
    min_length: 12             # Minimum 12 characters
    require_uppercase: true
    require_lowercase: true
    require_numbers: true
    require_special: true
    max_age_days: 90          # Force rotation every 90 days
    history_count: 5          # Can't reuse last 5 passwords
    lockout_attempts: 5       # Lock after 5 failed attempts
    lockout_duration: 900     # 15 minutes lockout

  # MFA Requirements
  mfa:
    required_for:
      - "production_admin"
      - "database_access"
      - "deployment_pipeline"
    supported_methods:
      - "totp"                # Time-based OTP
      - "webauthn"            # WebAuthn/FIDO2
      - "backup_codes"        # Backup codes
    grace_period_days: 7      # 7 days to enable MFA

# =============================================================================
# API SECURITY THRESHOLDS
# =============================================================================

api_security:
  # Rate Limiting
  rate_limiting:
    unauthenticated:
      requests_per_minute: 60
      requests_per_hour: 1000
      requests_per_day: 10000

    authenticated:
      requests_per_minute: 300
      requests_per_hour: 10000
      requests_per_day: 100000

    admin:
      requests_per_minute: 1000
      requests_per_hour: 50000
      requests_per_day: 500000

  # CORS Configuration
  cors:
    allowed_origins:
      production:
        - "https://aclue.app"
        - "https://www.aclue.app"
        - "https://aclue.co.uk"
        - "https://www.aclue.co.uk"
      staging:
        - "https://staging.aclue.app"
      development:
        - "http://localhost:3000"
        - "http://localhost:8000"
    allowed_methods:
      - "GET"
      - "POST"
      - "PUT"
      - "DELETE"
      - "OPTIONS"
    max_age_seconds: 86400    # 24 hours
    allow_credentials: true

  # Security Headers
  security_headers:
    required:
      - header: "X-Content-Type-Options"
        value: "nosniff"
      - header: "X-Frame-Options"
        value: "DENY"
      - header: "X-XSS-Protection"
        value: "1; mode=block"
      - header: "Strict-Transport-Security"
        value: "max-age=31536000; includeSubDomains"
      - header: "Content-Security-Policy"
        value: "default-src 'self'"
      - header: "Referrer-Policy"
        value: "strict-origin-when-cross-origin"
      - header: "Permissions-Policy"
        value: "geolocation=(), microphone=(), camera=()"

# =============================================================================
# MONITORING & ALERTING THRESHOLDS
# =============================================================================

monitoring_thresholds:
  # Security event thresholds
  security_events:
    failed_auth_attempts:
      threshold: 10            # Alert after 10 failed attempts
      window_minutes: 5        # Within 5 minutes
      severity: "high"

    privilege_escalation:
      threshold: 1             # Alert on any attempt
      window_minutes: 1        # Immediately
      severity: "critical"

    data_exfiltration:
      threshold_mb: 100        # Alert on >100MB transfer
      window_minutes: 10       # Within 10 minutes
      severity: "critical"

  # Performance degradation
  performance:
    response_time_ms:
      p50_threshold: 200       # 50th percentile < 200ms
      p95_threshold: 1000      # 95th percentile < 1s
      p99_threshold: 5000      # 99th percentile < 5s

    error_rate:
      threshold_percent: 1     # Alert on >1% error rate
      window_minutes: 5        # Within 5 minutes

    availability:
      threshold_percent: 99.9  # Alert on <99.9% availability
      window_minutes: 60       # Within 1 hour

# =============================================================================
# COMPLIANCE & AUDIT REQUIREMENTS
# =============================================================================

compliance_requirements:
  # Data protection
  data_protection:
    encryption_at_rest: true
    encryption_in_transit: true
    data_classification:
      - "public"
      - "internal"
      - "confidential"
      - "restricted"
    retention_policies:
      logs: 90                 # 90 days
      metrics: 365             # 1 year
      audit_trail: 2555        # 7 years

  # Audit logging
  audit_logging:
    required_events:
      - "authentication"
      - "authorization"
      - "data_access"
      - "configuration_change"
      - "privilege_escalation"
    retention_days: 2555       # 7 years
    immutable_storage: true
    real_time_streaming: true

  # Regulatory compliance
  regulatory:
    gdpr:
      enabled: true
      data_portability: true
      right_to_deletion: true
      consent_management: true

    pci_dss:
      enabled: true
      network_segmentation: true
      encryption_required: true
      audit_logging: true

    iso_27001:
      enabled: true
      risk_assessment: "quarterly"
      security_review: "monthly"
      incident_response: true

# =============================================================================
# EXCEPTION HANDLING
# =============================================================================

exception_handling:
  # Approval requirements
  approval_matrix:
    critical:
      approvers: ["security_team", "cto"]
      min_approvals: 2
      max_duration_hours: 24

    high:
      approvers: ["security_team", "tech_lead"]
      min_approvals: 2
      max_duration_hours: 72

    medium:
      approvers: ["tech_lead", "senior_dev"]
      min_approvals: 1
      max_duration_hours: 168  # 1 week

    low:
      approvers: ["senior_dev"]
      min_approvals: 1
      max_duration_hours: 720  # 30 days

  # Exception types
  exception_types:
    temporary:
      max_duration_days: 30
      requires_remediation_plan: true
      requires_compensating_controls: true

    permanent:
      requires_risk_assessment: true
      requires_executive_approval: true
      review_frequency: "quarterly"

    emergency:
      max_duration_hours: 24
      requires_incident_ticket: true
      requires_post_mortem: true

  # Audit trail
  audit_requirements:
    fields:
      - "exception_id"
      - "vulnerability_id"
      - "severity"
      - "approver"
      - "justification"
      - "compensating_controls"
      - "expiry_date"
      - "remediation_plan"
    retention_years: 7
    immutable: true

# =============================================================================
# QUALITY GATES
# =============================================================================

quality_gates:
  # Gate levels
  gates:
    - name: "commit"
      checks: ["secrets", "linting"]
      fail_fast: true

    - name: "pull_request"
      checks: ["secrets", "sast", "dependencies", "licenses"]
      fail_fast: false

    - name: "pre_deployment"
      checks: ["all"]
      fail_fast: true

    - name: "production"
      checks: ["all"]
      fail_fast: true
      require_approval: true

  # Success criteria
  success_criteria:
    security_score:
      minimum: 85              # Minimum 85/100 security score
      target: 90               # Target 90/100

    coverage:
      code_coverage: 80        # 80% code coverage
      security_coverage: 100   # 100% security rule coverage

    compliance:
      policy_violations: 0     # Zero policy violations
      exception_ratio: 0.05    # <5% exceptions

# =============================================================================
# NOTES
# =============================================================================

notes:
  - "All thresholds are subject to monthly review"
  - "Emergency overrides require incident ticket"
  - "Production deployments require security sign-off"
  - "Exceptions must be documented and time-bound"
  - "Security debt must be tracked and prioritised"
